---
layout: post
title: "汇编语言"
date: 2021-3-29 17:00:00 +0800
categories: r0code
---

# 32位 
## 基本寄存器
### 8个32位通用寄存器:
#### 4个数据寄存器(EAX、EBX、ECX和EDX)
    eax: 寄存器EAX通常称为累加器(Accumulator)，用累加器进行的操作可能需要更少时间。可用于乘、 除、输入/输出等操作，使用频率很高；也通常用作函数调用返回值。
    ebx: 寄存器EBX称为基地址寄存器(Base Register)。它可作为存储器指针来使用；
    ecx: 寄存器ECX称为计数寄存器(Count Register)。 在循环和字符串操作时，要用它来控制循环次数；在位操作中，当移多位时，要用CL来指明移位的位数；
    edx: 寄存器EDX称为数据寄存器(Data Register)。在进行乘、除运算时，它可作为默认的操作数参与运算，也可用于存放I/O的端口地址。
    
| 32  | 16  | 高8  | 低8  |
|:---:|:---:|:---:|:---:|
| EAX | AX  | AH  | AL  |
| EBX | BX  | BH  | BL  |
| ECX | CX  | CH  | CL  |
| EDX | DX  | DH  | DL  |


#### 2个变址和指针寄存器(ESI和EDI)
    寄存器ESI、EDI、SI和DI称为变址寄存器(Index Register)，它们主要用于存放存储单元在段内的偏移量， 它们可作一般的存储器指针使用。
    
| 32  | 16  |
|:---:|:---:|
| ESI | SI  |
| EDI | DI  |


#### 2个指针寄存器(ESP和EBP)
    它们主要用于访问堆栈内的存储单元，并且规定：
    esp: EBP为基指针(Base Pointer)寄存器，一般作为当前堆栈的最后单元，用它可直接存取堆栈中的数据；
    ebp: 为堆栈指针(Stack Pointer)寄存器，用它只可访问栈顶。
    
    
| 32  | 16  |
|:---:|:---:|
| EBP | BP  |
| ESP | SP  |


### 6个段寄存器(ES、CS、SS、DS、FS和GS)
    es
    cs
    ss
    ds
    fs
    gs
    
### 1个指令指针寄存器(EIP)
    eip ：32位CPU把指令指针扩展到32位，并记作EIP，指令指针EIP、IP(Instruction Pointer)是存放下次将要执行的指令在代码段的偏移量。
    
### 1个标志寄存器(EFlags)
    CF：进位标志
    OF：溢出标志
    SF：符号标志
    ZF：零标志
    AC：辅助进位标志
    PF：奇偶标志

# 64位
## 64位x86-64处理器架构
1) 向后兼容 x86 指令集。
2) 地址长度为 64 位，虚拟地址空间为 2 64 字节。按照当前芯片的实现情况，只能使用地址的低 48 位。
3) 可以使用 64 位通用寄存器，允许指令具有 64 位整数操作数。
4) 比 x86 多了 8 个通用寄存器。
5) 物理地址为 48 位，支持高达 256TB 的 RAM。
    
    当处理器运行于本机 64 位模式时，是不支持 16 位实模式或虚拟 8086 模式的。（在传统模式（legacy mode）下，还是支持 16 位编程，但是在 Microsoft Windows 64 位版本中不可用。）

## 64 位操作模式
    Intel 64 架构引入了一个新模式，称为 IA-32e。从技术上看，这个模式包含两个子模式：兼容模式（compatibility mode）和 64 位模式（64-bit mode）。不过它们常常被看做是模式而不是子模式，因此，先来了解这两个模式。
1) 兼容模式
    在兼容模式下，现有的 16 位与 32 位应用程序通常不用进行重新编译就可以运行。但是，16 位 Windows（Win16）和 DOS 应用程序不能运行在 64 位 Microsoft Windows 下。 与早期 Windows 版本不同，64 位 Windows 没有虚拟 DOS 机器子系统来利用处理器的功能切换到虚拟 8086 模式。
2) 64 位模式
    在 64 位模式下，处理器执行的是使用 64 位线性地址空间的应用程序。这是 64 位 Microsoft Windows 的原生模式，该模式能使用 64 位指令操作数。
    
## 基本 64 位执行环境
### 64 位模式下，虽然处理器现在只能支持 48 位的地址，但是理论上，地址最大为 64 位。从寄存器来看，64 位模式与 32 位最主要的区别如下所示：
* 16 个 64 位通用寄存器（32 位模式只有 8 个通用寄存器）
* 8 个 80 位浮点寄存器
* 1 个 64 位状态标志寄存器 RFLAGS （只使用低 32 位）
* 1 个 64 位指令指针寄存器 RIP

### 32 位标志寄存器和指令指针寄存器分别称为 EFLAGS 和 EIP。此外，还有一些 x86 处理器用于多媒体处理的特殊寄存器：
* 8 个 64 位 MMX 寄存器
* 16 个 128 位 XMM 寄存器（32 位模式只有 8 个 XMM 寄存器）

## 通用寄存器
    在《32位x86处理器》一节中介绍 32 位处理器时介绍过通用寄存器，它们是算术运算、数据传输和循环遍历数据指令的基本操作数。通用寄存器可以访问 8 位、16 位、32 位或 64 位操作数（需使用特殊前缀）。
    64 位模式下，操作数的默认大小是 32 位，并且有 8 个通用寄存器。但是，给每条指令加上 REX（寄存器扩展）前缀后，操作数可以达到 64 位，可用通用寄存器的数量也增加到 16 个：32 位模式下的寄存器，再加上 8 个有标号的寄存器，R8 到 R15。下表给出了 REX 前缀下可用的寄存器。

| 操作数大小 | 可用寄存器                                                                 |
|:-----:|:---------------------------------------------------------------------:|
| 8 位   | AL、BL、CL、DL、DIL、SIL、BPL、SPL、R8L、R9L、R10L、R11L、R12L、R13L、R14L、R15L     |
| 16 位  | AX、BX、CX、DX、DI、SI、BP、SP、R8W、R9W、R10W、R11W、R12W、R13W、R14W、R15W         |
| 32 位  | EAX、EBX、ECX、EDX、EDI、ESI、EBP、ESP、R8D、R9D、R10D、R11D、R12D、R13D、R14D、R15D |
| 64 位  | RAX、RBX、RCX、RDX、RDI、RSI、RBP、RSP、R8、R9、R10、R11、R12、R13、R14、R15         |



还有一些需要记住的细节：
64 位模式下，单条指令不能同时访问寄存器高字节，如 AH、BH、CH 和 DH，以及新字节寄存器的低字节（如 DIL）。
64 位模式下，32 位 EFLAGS 寄存器由 64 位 RFLAGS 寄存器取代。这两个寄存器共享低 32 位，而 RFLAGS 的高 32 位是不使用的。
32 位模式和 64 位模式具有相同的状态标志。


## 64位和32位的寄存器和汇编的比较
### 64位寄存器分配的不同

# 指令简表
## 1.数据传送指令
    
| 汇编格式             |  指令的操作                  |
|------------------|--------------------|
| :-:              | :-:                |
| mov dest,source  | 数据传送               |
| CBW              | 字节转换成字             |
| CWD              | 字转换成双字             |
| LAHF             | FLAGS低8位装入AH寄存器    |
| SAHF             | AH寄存器内容送到FLAGS低8位  |
| LDS dest,source  | 设定数据段指针            |
| LES dest,source  | 设定附加段指针            |
| LEA dest,source  | 装入有效地址             |
| PUSH source      | 将一个字压入栈顶           |
| POP dest         | 将一个字从栈顶弹出          |
| PUSHF            | 将标志寄存器FLAGS的内容压入栈顶 |
| POPF             | 将栈顶内容弹出到标志寄存器FLAGS |
| XCHG dest,source | 交换                 |
| XLAT source      | 表转换                |

## 2.算数运算指令

| 汇编格式            | 指令的操作      |
|:---------------:|:----------:|
| AAA             | 加法的ASCII调整 |
| AAD             | 除法的ASCII调整 |
| AAM             | 乘法的ASCII调整 |
| AAS             | 减法的ASCII调整 |
| DAA             | 加法的十进制调整   |
| DAS             | 减法的十进制调整   |
| MUL source      | 无符号乘法      |
| IMUL source     | 整数乘法       |
| DIV source      | 无符号除法      |
| IDIV            | 整数除法         |
| ADD dest,source | 加法         |
| ADC dest,source | 带进位加       |
| SUB dest,source | 减法         |
| SBB dest,source | 带借位减       |
| CMP dest,source | 比较         |
| INC dest        | 加1         |
| DEC dest        | 减1         |
| NEG dest        | 求补         |

## 3.逻辑运算指令

| 汇编格式             | 指令的操作         |
|:----------------:|:-------------:|
| AND dest,source  | 逻辑‘与’         |
| OR dest,source   | 逻辑‘或’         |
| XOR dest,source  | 逻辑‘或非’        |
| NOT dest         | 逻辑‘非’         |
| TEST dest,source | 测试（非破坏性逻辑‘与’） |


## 4.移位指令

| 汇编格式                 | 指令的操作     |
|:--------------------:|:---------:|
| RCL dest,count       | 通过进位循环左移  |
| RCR dest,count       | 通过进位循环右移  |
| ROL dest,count       | 循环左移      |
| ROR dest,count       | 循环右移      |
| SHL / SAL dest,count | 逻辑左移/算数左移 |
| SHR dest,count       | 逻辑右移      |
| SAR dest,count       | 算术右移      |


## 5.串操作指令

| 汇编格式                             | 指令的操作        |
|:--------------------------------:|:------------:|
| MOVS / MOVSB / MOVSW dest,source | 字符串传送        |
| CMPS / CMPSB / CMPSW dest,source | 字符串比较        |
| LODS / LODSB / LODSW source      | 装入字节串或字串到累加器 |
| STOS / STOSB / STOSW dest        | 存储字节串或字串     |
| SCAS / SCASB / SCASW dest        | 字符串扫描        |


## 6.1.程序控制指令

| 汇编格式                         | 指令的操作                |
|:----------------------------:|:--------------------:|
| CALL dest                    | 调用一个过程（子程序）          |
| RET \[ 弹出字节数（必须为偶数）\]        | 从过程（子程序）返回           |
| INT int\_type                | 软件中断                 |
| INTO                         | 溢出中断                 |
| IRET                         | 从中断返回                |
| JMP dest                     | 无条件转移                |
| JG / JNLE short\_label       | 大于或不小于等于转移           |
| JGE / JNL short\_label       | 大于等于或不小于转移           |
| JL / JNGE short\_label       | 小于或不大于等于转移           |
| JLE / JNG short\_label       | 小于等于或不大于转移           |
| JA / JNBE short\_label       | 高于或不低于等于转移           |
| JAE / JNB short\_label       | 高于等于或不低于转移           |
| JB / JNAE short\_label       | 低于或不高于等于转移           |
| JBE / JNA short\_label       | 低于等于或不高于转移           |
| JO short\_label              | 溢出标志为1转移（溢出转移）       |
| JNO short\_label             | 溢出标志为0转移（无溢出转移）      |
| JS short\_label              | 符号标识为1转移（结果为负转移）     |
| JNS short\_label             | 符号标识为1转移（结果为正转移）     |
| JC short\_label              | 进位标志为1转移（有进位转移）      |
| JNC short\_label             | 进位标志为0转移（无进位转移）      |
| JZ / JE short\_label         | 零标志为1转移（等于或为0转移）     |
| JNZ /JNE short\_label        | 零标志为0转移（不等于或不为0转移）   |
| JP /JPE short\_label         | 奇偶标志为1转移（结果中有偶数个1转移） |
| JNP / JPO short\_label       | 奇偶标志为0转移（结果中有奇数个1转移） |
| JCXZ short\_label            | 若CX=0则转移             |
| LOOP short\_label            | CX 不等于0时循环           |
| LOOPE / LOOPZ short\_label   | CX不等于0且ZF=1时循环       |
| LOOPNE / LOOPNZ short\_label | CX不等于0且ZF=0时循环       |
| STC                          | 进位标志置1               |
| CLC                          | 进位标识置0               |
| CMC                          | 进位标志取反               |
| STD                          | 方向标志置1               |
| CLD                          | 方向标志置0               |


## 6.2.程序控制指令

| 汇编格式 | 指令的操作                 |
|:----:|:---------------------:|
| STI  | 中断标志置1（允许可屏蔽中断）       |
| CLI  | 中断标志置0（禁止可屏蔽中断）       |
| ESC  | CPU交权                 |
| HLT  | 停机                    |
| LOCK | 总线封锁                  |
| NOP  | 无操作                   |
| WAIT | 等待至TEST（上边有个横线）信号有效为止 |


## 7.输入/输出指令

| 汇编格式          | 指令的操作       |
|:-------------:|:-----------:|
| IN acc,source | 从外设接口输入字节或字 |
| OUT dest,acc  | 向外设接口输出字节或字 |


## 备注：
    dest 目的操作数、目的串
    source 源操作数、源串
    acc 累加器
    count 计数值
    int_type 中断类型号
    short_label 短距离标号
